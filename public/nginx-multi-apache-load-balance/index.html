<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="豪翔天下的博客,haoflynet,haofly"><title>Nginx + 多Apache 做反向代理实现负载均衡并设置二级域名 | 豪翔天下</title><link rel="stylesheet" type="text/css" href="/css/normalize.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/pure-min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Nginx + 多Apache 做反向代理实现负载均衡并设置二级域名</h1><a id="logo" href="/.">豪翔天下</a><p class="description">Change My World by Program</p></div><div id="nav-menu"><a href="/." class="current"><i class="icon-home"> 首页</i></a><a href="/archives/"><i class="icon-archive"> 归档</i></a><a href="/about/"><i class="icon-about"> 关于</i></a><a href="/favorites.html"><i class="icon-archive"> 我的收藏</i></a><a href="/atom.xml"><i class="icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">Nginx + 多Apache 做反向代理实现负载均衡并设置二级域名</h1><div class="post-meta">2014-10-23<span class="categories"> | 分类于<a href="/categories/编程之路/"> 编程之路</a></span></div><span data-disqus-identifier="nginx-multi-apache-load-balance/" class="disqus-comment-count"></span><div class="post-content"><p>参考文章：<a href="http://blog.csdn.net/yanggd1987/article/details/31375573" target="_blank" rel="external">http://blog.csdn.net/yanggd1987/article/details/31375573
</a><br><a href="http://www.oschina.net/question/56436_109188" target="_blank" rel="external">http://www.oschina.net/question/56436_109188</a></p>
<p>在网上找了几天时间，发现网上的方法都有一定的局限性，因为我想要的是在同一台服务器上实现一个nginx做反向代理到多个apache(再一次感叹网上好多教程的落<br>后和千篇一律)。这里再次记录本次的配置过程。</p>
<p>环境：Ubuntu14.04 server + nginx(1.4.6) + apache2(2.4.7)<br>目的：使用nginx做代理，分别代理到apache的四个监听端口8080/8081/8082/8083 优点：Nginx可应付高并发，使用Proxy做代理效<br>率也较高，占用资源少，再使用apache处理后端，也更稳定，现在一般的做法是是用nginx处理前端，apache处理后端，我这里暂时全部交由apache处理<br>。当然，我这里都是在同一台服务器上做的，除了减少单个apache的并发处理数量，对性能来说并没有显著的提升。</p>
<h3 id="1-_u5B89_u88C5nginx_u548Capache2"><a href="#1-_u5B89_u88C5nginx_u548Capache2" class="headerlink" title="1.安装nginx和apache2"></a>1.安装nginx和apache2</h3><p>安装到没什么好说的，直接<code>apt-get</code>安装即可。</p>
<h3 id="2-_u4FEE_u6539nginx_u7684_u914D_u7F6E_u6587_u4EF6/etc/nginx/nginx-etc"><a href="#2-_u4FEE_u6539nginx_u7684_u914D_u7F6E_u6587_u4EF6/etc/nginx/nginx-etc" class="headerlink" title="2.修改nginx的配置文件/etc/nginx/nginx.etc"></a>2.修改nginx的配置文件/etc/nginx/nginx.etc</h3><p>在http字段(就是那个大括号里面)添加如下内容：</p>
<pre><code>upstream balance\{
    server localhost:8080;
    server localhost:8081;
    server localhost:8082;
    server localhost:8083;
\}




server\{
    listen 80;
    server_name haofly.net;
    localhost /\{
        proxy_pass http://balance;
    \}
\}
</code></pre><p>其中nginx是让upstream里面的各个IP/端口实现轮询访问，研究一下nginx的配置文件，还可以对轮询访问加上一些限制条件，比如轮训机制、权值分配等<br>，这里不做详述。</p>
<p>需要注意的是如果是二级域名，那么upstream里面的server依然写成<code>localhost:port</code>的形式，而不用去写什么二级域名，二级域名在apac<br>he的配置文件里面定义，nginx会直接将那些都传给它的。</p>
<h3 id="3-_u4FEE_u6539apache_u7684_u914D_u7F6E_u6587_u4EF6"><a href="#3-_u4FEE_u6539apache_u7684_u914D_u7F6E_u6587_u4EF6" class="headerlink" title="3.修改apache的配置文件"></a>3.修改apache的配置文件</h3><p>主配置文件<code>/etc/apache2/apache2.conf</code>，在#ServerRoot<br>“/etc/apache”下添加一行指明ServerName，例如：</p>
<pre><code>#ServerRoot &quot;/etc/apache2&quot;
ServerName haofly.net
</code></pre><p>虚拟目录配置文件(这就相当于为apache多开了几个线程，就好像是有多个apache在同时工作一样) <code>vim /etc/apache2/sites-
available/000-default.conf</code>(这是默认的那个80端口的配置文件)，只需要把里面的80端口改为8080即可。然后再新建几个配置文件<br><code>vim /etc/apache2/sites-available/proxy01.conf</code>内容如下：</p>
<pre><code>&lt;VirtualHost *:8081&gt;
    ServerAdmin localhost:8081
    DocumentRoot /var/www/html





ErrorLog $\{APACHE_LOG_DIR\}/error.log
CustomLog $\{APACHE_LOG_DIR\}/access.log combined
</code></pre><p></p>
<p>8082端口的配置文件proxy02.conf只需要把端口改为8082即可，另外为方便测试，我们需要把8083端口的配置文件特殊化一下，<code>vim
/etc/apache2/sites-available/proxy03.conf</code>，内容如下：</p>
<pre><code>&lt;VirtualHost *:8083&gt;
    ServerAdmin localhost:8083
    DocumentRoot /var/www/test





ErrorLog $\{APACHE_LOG_DIR\}/error.log
CustomLog $\{APACHE_LOG_DIR\}/access.log combined
</code></pre><p></p>
<p>其实只是修改了DocumentRoot，使它指向/var/www/test，这样就方便测试了，在/var/www/test下新建一个文件<code>vim
/var/www/test/index.html</code>，内容如下</p>
<pre><code>&lt;html&gt;
 hehe
&lt;/html&gt;
</code></pre><p>在把配置文件链接到<code>/etc/apache2/sites-available</code>文件夹：</p>
<pre><code>cd ../sites-enabled
sudo ln -s ../sites-available/proxy01.conf
sudo ln -s ../sites-available/proxy02.conf
sudo ln -s ../sites-available/proxy03.conf
</code></pre><p>最后再修改apache的端口文件<code>vim /etc/apache2/ports.conf</code>，把Listen *80修改为：</p>
<pre><code>Listen 8080
Listen 8081
Listen 8082
Listen 8083
</code></pre><h3 id="4-_u6D4B_u8BD5"><a href="#4-_u6D4B_u8BD5" class="headerlink" title="4.测试"></a>4.测试</h3><p>首先检查配置文件是否有语法错误</p>
<pre><code>nginx -t
apachectl -t
</code></pre><p>如果都OK，就可以重启了：</p>
<pre><code>service apache2 restart
service nginx stop
service nginx start
</code></pre><p>然后在浏览器输入上面的Servername，即<a href="http://haofly.net，多刷新几次，就会发现，有时候出现的是apache的界面，有时候出现的是te" target="_blank" rel="external">http://haofly.net，多刷新几次，就会发现，有时候出现的是apache的界面，有时候出现的是te</a><br>st下那个hehe界面。</p>
<h3 id="5-nginx_u6DFB_u52A0_u4E8C_u7EA7_u57DF_u540D"><a href="#5-nginx_u6DFB_u52A0_u4E8C_u7EA7_u57DF_u540D" class="headerlink" title="5.nginx添加二级域名"></a>5.nginx添加二级域名</h3><p>比apache简单多了，我这里不仅添加了二级域名，并且也实现了一个反向代理，在/etc/nginx/nginx.conf里面的http里面添加一个upstr<br>eam和一个server即可：</p>
<pre><code>upstream \{
   server localhost:8084;
\}
server \{
    server_name aa.hostname.com;
    listen               80;
    location / \{
      proxy_pass http://er;
      proxy_redirect default;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $http_connection;
    \}
\}
</code></pre><p>然后就像<a href="http://haofly.net/linuxvirtualhost/" title="Link:
http://haofly.net/linuxvirtualhost/">Linux使用虚拟主机设置一、二级域名和虚拟目录</a> 那样设置apache即可。</p>
</div><a data-url="http://haofly.net/nginx-multi-apache-load-balance/" data-id="ciki4pbjn003k75rxd1j9aw2m" class="article-share-link">分享到</a><div class="tags"></div><div class="post-nav"><a href="/python-execute-pythonfile-effiency/" class="pre"><i class="icon-previous">在Python3代码里执行另一个python文件的几种访问及其效率的比较</i></a><a href="/python-configparser/" class="next">Python3使用configparser模块设置配置信息<i class="icon-next"></i></a></div><div id="disqus_thread"><script>var disqus_shortname = 'haoflynet';
var disqus_identifier = 'nginx-multi-apache-load-balance/';
var disqus_title = 'Nginx + 多Apache 做反向代理实现负载均衡并设置二级域名';
var disqus_url = 'http://haofly.net/nginx-multi-apache-load-balance/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//haoflynet.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search" class="search-form-input"/><input type="hidden" name="sitesearch" value="http://haofly.net"/></form></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/就是爱玩/">就是爱玩</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程之路/">编程之路</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/边走边想/">边走边想</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/那时年少/">那时年少</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/韦编三绝/">韦编三绝</a></li></ul></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/maitianshouwangzhe/">我越来越像《麦田守望者》</a></li><li class="post-list-item"><a class="post-list-link" href="/mysql-update/">MySQL数据库升级过程</a></li><li class="post-list-item"><a class="post-list-link" href="/mysql-master-slave/">Mysql之主从复制</a></li><li class="post-list-item"><a class="post-list-link" href="/python-multithreading-multiprocess/">Python多进程和多线程</a></li><li class="post-list-item"><a class="post-list-link" href="/mysql-migration/">MySQL数据库目录存放位置迁移</a></li><li class="post-list-item"><a class="post-list-link" href="/design-pattern/">[转]23种设计模式</a></li><li class="post-list-item"><a class="post-list-link" href="/mysql-optimization/">MySQL之调优方法</a></li><li class="post-list-item"><a class="post-list-link" href="/mysql-design-tips/">MySQL之设计方法</a></li><li class="post-list-item"><a class="post-list-link" href="/raspberrypi/">玩转树莓派2</a></li><li class="post-list-item"><a class="post-list-link" href="/database-application-scenarios/">各种数据库的应用场景</a></li></ul></div><div class="widget"><div class="widget-title">最近评论</div><script type="text/javascript" src="//haoflynet.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title">友情链接</div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div></div><div id="footer">© <a href="/." rel="nofollow">豪翔天下.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/jquery.min.js?v=0.0.0"></script><script type="text/javascript" src="/js/totop.js?v=0.0.0"></script><script type="text/javascript" src="/js/fancybox.pack.js?v=0.0.0"></script><script type="text/javascript" src="/js/jquery.fancybox.js?v=0.0.0"></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?d06802e96e214bdb413a40b263d4cc15";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script><script type="text/javascript" src="/js/share.js?v=0.0.0"></script></div></body></html>